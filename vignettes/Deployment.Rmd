---
title: "Deployment Notes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Deployment Notes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


### Setting up the remote Server


Using Ubuntu 20.04

Install system libraries for common packages (The following covers the packages installed on the standard desktop image - had to tweak tcl and libopenmpi versions from autogenerated), plus dependencies needed for systemPipeShiny (which we use for testing, as it's complicated with lots of dependencies):

    sudo apt install pandoc pandoc-citeproc libssl-dev libxml2-dev libcurl4-openssl-dev libcairo2 libcairo2-dev git-core zlib1g-dev jags default-jre-headless libopenmpi3 libopenmpi-dev libomp-dev make libgit2-dev libssh2-1-dev libgmp10 libgmp-dev libglpk-dev libpng-dev python gdal-bin libproj-dev libgdal-dev libmpfr-dev libgeos-dev libgeos++-dev libsodium-dev libicu-dev tcl8.6 tk8.6 tk-table libudunits2-dev libv8-dev librsvg2-dev libssh-dev libxt-dev libcairo-5c-dev



(This list covers most of the debs needed for common R packages - e.g. tidyverse, sf, etc.
See: <https://github.com/rstudio/r-system-requirements> and <https://github.com/r-hub/sysreqsdb> for two (different) databases of OS package dependencies for R libraries. `./librarydeps/getdeps.R` will produce a (draft) apt install line for a given set of packages)


Install R following instructions at <https://docs.rstudio.com/resources/install-r/> (I went with most recent version (4.1.1 at time of writing). Note `r-base` with Ubuntu 20.04 is very old, so don't use Ubuntu provided packages. Set up the symlinks as described on that page.

Start R as root, and install shiny, rmarkdown, devtools and packrat packages:

`sudo R`

`install.packages(c("shiny", "rmarkdown", "packrat", "devtools"))`

`q()`

Install Shiny server (<https://www.rstudio.com/products/shiny/download-server/ubuntu/>), e.g.:

(check you're getting latest version of Shiny Server - note URL is ubuntu-14.04, even though we're using 20.04)

    sudo apt-get install gdebi-core
    wget https://download3.rstudio.org/ubuntu-14.04/x86_64/shiny-server-1.5.16.958-amd64.deb
    sudo gdebi shiny-server-1.5.16.958-amd64.deb

Check Shiny server is working correctly - go to <http://server:3838>, and check the Shiny and RMarkdown apps appear in frames on the right hand side.

Setup timezone on the server

`sudo dpkg-reconfigure tzdata`

Edit `/etc/shiny-server/shiny-server.conf`:

    # Instruct Shiny Server to run applications as the user "shiny"
    run_as shiny;

    # Define a server that listens on port 3838 on localhost
    server {
      listen 3838 127.0.0.1;


      location / {
        run_as :HOME_USER:;
        user_dirs;
        directory_index off;
      }

    }

Restart Shiny Server `sudo service shiny-server restart`

Make it so that user's cannot read others' home directories (<https://superuser.com/a/615990>): update `DIR_MODE` to `DIR_MODE=0750` in `/etc/adduser.conf` and change permissions on any existing homedirs.

(ShinyServer "su"s to the user when serving apps from `~/ShinyApps`, so this will still work)

Add users either using `adduser` for regular accounts / RIT script for UoM authentication.

### Nginx

We use a reverse proxy to serve the apps, and handle https

Modify `location /` of `/etc/nginx/sites-available/default` to:

```
        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
#               try_files $uri $uri/ =404;
                proxy_pass http://127.0.0.1:3838/;
                proxy_redirect http://127.0.0.1:3838/ $scheme://$host/;
                proxy_http_version 1.1;

                # $http_upgrade and $connection_upgrade are set up
                # in /etc/nginx/nginx.conf
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_read_timeout 20d;
                proxy_buffering off;
        }

```

Add the following to the `http` section of `/etc/nginx/nginx.conf`:


```
        # For Shiny proxy
          map $http_upgrade $connection_upgrade {
            default upgrade;
            ''      close;
        }


```

(based on https://www.r-bloggers.com/2016/03/add-authentication-to-shiny-server-with-nginx/ and https://support.rstudio.com/hc/en-us/articles/213733868-Running-Shiny-Server-with-a-Proxy)

Edit `/etc/issue.net` to make it clear that the server is only for hosting public Shiny apps, and that the user is responsible for them. (This text will be displayed in the R console when the user connects to the server)

### https

We use [Let's Encrypt](https://letsencrypt.org/getting-started/) to handle the 
server certificates for https.  Certbot automatically sets this up using the 
nginx config

(TODO use UoM signed certificate)


### Shinyproxy notes (very incomplete)

This section contains notes and thoughts about how we might switch to a Shinyproxy based setup. This would provide better scaling for apps, since each user of each app gets its own Dockerised instance.

Published apps need to be added to `application.yml` and the server restarted. This causes all current users sessions to be ended. <https://shinyproxy.io/documentation/configuration/#session-persistence> suggests we can keep the sessions open using Redis (unclear what happens during the \~20 seconds the Shinyproxy is restarting and we get a 502 error)

If we go down this route, we'd probably want to mount /home as /home in Docker container (how to handle permissions???) so the Packrat libraries are available (and in the same place within and without the container)

(See also notes on local Wekan server)
